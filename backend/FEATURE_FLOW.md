# Feature to Model Flow Diagram

Visual representation of how features map to models and API keys.

## ğŸ¯ Current System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER REQUEST                             â”‚
â”‚  (Chat, Flashcard, MCQ, High-Yield, Explain, Map, Clinical...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODEL ROUTER                                  â”‚
â”‚              (services/model_router.py)                          â”‚
â”‚                                                                   â”‚
â”‚  Feature â†’ Provider Mapping:                                     â”‚
â”‚  â€¢ chat         â†’ gemini                                         â”‚
â”‚  â€¢ flashcard    â†’ gemini                                         â”‚
â”‚  â€¢ mcq          â†’ gemini                                         â”‚
â”‚  â€¢ highyield    â†’ gemini                                         â”‚
â”‚  â€¢ explain      â†’ gemini                                         â”‚
â”‚  â€¢ map          â†’ gemini                                         â”‚
â”‚  â€¢ image        â†’ gemini                                         â”‚
â”‚  â€¢ clinical     â†’ gemini                                         â”‚
â”‚  â€¢ osce         â†’ gemini                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODEL CONFIG                                  â”‚
â”‚              (config/model_config.py)                            â”‚
â”‚                                                                   â”‚
â”‚  Loads: backend/models.json                                      â”‚
â”‚  {                                                                â”‚
â”‚    "gemini": {                                                    â”‚
â”‚      "chat": "models/gemini-2.5-flash"  â† ALL FEATURES USE THIS â”‚
â”‚    }                                                              â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API KEY SELECTION                             â”‚
â”‚              (model_router.py)                                   â”‚
â”‚                                                                   â”‚
â”‚  Priority Order:                                                 â”‚
â”‚  1. User Personal Key (user_api_keys table)                     â”‚
â”‚  2. Admin Pool Key (api_keys table, status='active')            â”‚
â”‚  3. Fallback to next key if failure                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROVIDER EXECUTION                            â”‚
â”‚              (services/providers/gemini.py)                      â”‚
â”‚                                                                   â”‚
â”‚  API Call:                                                        â”‚
â”‚  POST https://generativelanguage.googleapis.com/v1beta/         â”‚
â”‚       models/gemini-2.5-flash:generateContent                    â”‚
â”‚                                                                   â”‚
â”‚  Headers: { "key": "selected_api_key" }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RESPONSE & TRACKING                           â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Return AI response to user                                    â”‚
â”‚  â€¢ Track usage (rate_limiter.py)                                â”‚
â”‚  â€¢ Log health check (health_monitor.py)                         â”‚
â”‚  â€¢ Update failure count if error                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ API Key Flow

```
User Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check User Personal Key â”‚
â”‚ (user_api_keys table)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ Found? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                           â”‚
           â–¼                           â–¼
      Use User Key              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                    â”‚ Check Admin Pool â”‚
           â”‚                    â”‚ (api_keys table) â”‚
           â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â”‚                             â”œâ”€ Found Active Key?
           â”‚                             â”‚
           â”‚                             â–¼
           â”‚                        Use Admin Key
           â”‚                             â”‚
           â”‚                             â”œâ”€ Failed?
           â”‚                             â”‚
           â”‚                             â–¼
           â”‚                        Try Next Key
           â”‚                             â”‚
           â”‚                             â”œâ”€ All Failed?
           â”‚                             â”‚
           â”‚                             â–¼
           â”‚                        Return Error
           â”‚                        (Trigger Maintenance)
           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              Execute API Call
```

## ğŸ“Š Feature Usage Tracking

```
API Call Success
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter            â”‚
â”‚  (rate_limiter.py)       â”‚
â”‚                          â”‚
â”‚  Increment:              â”‚
â”‚  â€¢ tokens_used           â”‚
â”‚  â€¢ requests_count        â”‚
â”‚  â€¢ feature_counter       â”‚
â”‚    (flashcards_generated,â”‚
â”‚     mcqs_generated, etc.)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check Limits            â”‚
â”‚  (PLAN_LIMITS)           â”‚
â”‚                          â”‚
â”‚  Free:   10K tokens/day  â”‚
â”‚  Basic:  100K tokens/day â”‚
â”‚  Pro:    1M tokens/day   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ Over Limit? â”€â”€â†’ Return 429 Error
           â”‚                  (Upgrade Prompt)
           â”‚
           â–¼
      Allow Request
```

## ğŸ”„ Model Change Impact

### Changing Model in models.json

```
Edit: backend/models.json
{
  "gemini": {
    "chat": "models/gemini-3-pro-preview"  â† Changed
  }
}
     â”‚
     â–¼
Server Auto-Reloads
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALL Features Now Use New Model:     â”‚
â”‚ â€¢ Chat                               â”‚
â”‚ â€¢ Flashcards                         â”‚
â”‚ â€¢ MCQ                                â”‚
â”‚ â€¢ High-Yield                         â”‚
â”‚ â€¢ Explain                            â”‚
â”‚ â€¢ Map                                â”‚
â”‚ â€¢ Image Analysis                     â”‚
â”‚ â€¢ Clinical Cases                     â”‚
â”‚ â€¢ OSCE Practice                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ Feature-Specific Models (Future)

To use different models per feature:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Chat       â”‚â”€â”€â”€â”€â†’â”‚ models/gemini-2.5-flash      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flashcard   â”‚â”€â”€â”€â”€â†’â”‚ models/gemini-2.5-flash-lite â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     MCQ      â”‚â”€â”€â”€â”€â†’â”‚ models/gemini-3-pro-preview  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Image     â”‚â”€â”€â”€â”€â†’â”‚ models/gemini-2.5-flash-imageâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Update `models.json`:
```json
{
  "gemini": {
    "chat": "models/gemini-2.5-flash",
    "flashcard": "models/gemini-2.5-flash-lite",
    "mcq": "models/gemini-3-pro-preview",
    "image": "models/gemini-2.5-flash-image"
  }
}
```

## ğŸ“ File Locations

```
backend/
â”œâ”€â”€ models.json                    â† Edit to change models
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ model_router.py           â† Feature â†’ Provider mapping
â”‚   â”œâ”€â”€ rate_limiter.py           â† Usage tracking
â”‚   â”œâ”€â”€ commands.py               â† Feature implementations
â”‚   â”œâ”€â”€ chat.py                   â† Chat feature
â”‚   â””â”€â”€ providers/
â”‚       â””â”€â”€ gemini.py             â† Gemini API calls
â””â”€â”€ config/
    â””â”€â”€ model_config.py           â† Model loading
```

## ğŸ” Quick Checks

**Which model is chat using?**
```bash
cat backend/models.json | grep -A 1 '"gemini"' | grep '"chat"'
```

**Which provider handles flashcards?**
```bash
grep -A 10 'provider_map = {' backend/services/model_router.py
```

**How many API keys are active?**
```sql
SELECT provider, feature, COUNT(*) 
FROM api_keys 
WHERE status='active' 
GROUP BY provider, feature;
```
